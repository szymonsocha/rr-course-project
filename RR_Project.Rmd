---
title: "Reproducible Research Project"
author: "Robert Kowalczyk, Szymon Socha, Karolina Szczęsna"
date: "`r Sys.Date()`"
output: 
  prettydoc::html_pretty:
    toc: true
    theme: cayman
    highlight: github
---

<style>
details {
  overflow: hidden;
  transition: max-height 0.5s ease-out;
  max-height: 30px;
}
details[open] {
  max-height: 500px;
}
details summary {
  cursor: pointer;
  font-weight: normal;
  font-style: italic;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This is an RMarkdown presentation that serves as a final project for the course Reproducible Research.\
The project's topic involves transcribing a ready-made [Python notebook](https://www.kaggle.com/code/anshigupta01/flight-price-prediction/notebook?fbclid=IwAR2vtpE8xwc7nhPqDwdEiwwImw62_XuIxTgEkG0Qo2OCCyHIONRIv7DD3pM), downloaded from the Kaggle platform, into R.\
Additionally, the analysis will be expanded to include an additional machine learning model.\
In order to make this project reproducible, we utilize the `dotenv` package to store the environment state.

Please note that under each cell, there is a button available to expand the rewritten Python code.

Team members:

- Robert Kowalczyk
- Szymon Socha
- Karolina Szczęsna

```{r}
suppressPackageStartupMessages(library(tidyverse))
library(readxl)
library(dplyr)
library(ggplot2)
library(DT)
library(ggpubr)
#library(caret)
#library(gridExtra)
```
<details>
  <summary>Python code</summary>
  ```python
  #importing libraries
  import pandas as pd 
  import numpy as np 
  import seaborn as sns 
  import matplotlib.pyplot as plt
  from sklearn.preprocessing import StandardScaler
  from sklearn.model_selection import train_test_split,GridSearchCV
  from sklearn.metrics import accuracy_score,confusion_matrix
  
  import warnings
  warnings.filterwarnings('ignore')
  ```
</details>

## Importing dataset

```{r}
df <- read_excel('data/Data_Train.xlsx')
head(df)
```
<details>
  <summary>Python code</summary>
  ```python
  df=pd.read_excel('/kaggle/input/flight-fare-prediction-mh/Data_Train.xlsx')
  df.head()
  ```
</details>

```{r}
str(df)
```
<details>
  <summary>Python code</summary>
  ```python
  df.info()
  ```
</details>

```{r}
summary(df)
```
<details>
  <summary>Python code</summary>
  ```python
  df.describe()
  ```
</details>

```{r}
dim(df)
```
<details>
  <summary>Python code</summary>
  ```python
  df.shape
  ```
</details>

```{r}
df %>% 
  summarise_all(~sum(is.na(.)))
```
<details>
  <summary>Python code</summary>
  ```python
  df.isnull().sum()
  ```
</details>

```{r}
df %>% 
  summarise_all(~ sum(is.na(.))) %>% 
  pivot_longer(everything(), names_to = "colname", values_to = "n_of_nas") %>%
  ggplot(., aes(x = colname, y=n_of_nas)) +
  geom_bar(stat = 'identity', fill = 'steelblue') +
  labs(x = 'Column', y = 'No. of NAs')
```
<details>
  <summary>Python code</summary>
  ```python
  import missingno as msno
  msno.bar(df)
  plt.show
  ```
</details>

```{r}
df <- df %>% drop_na()
```
<details>
  <summary>Python code</summary>
  ```python
  df.dropna(inplace=True)
  ```
</details>

```{r}
df %>% summarise_all(~sum(is.na(.)))
```
<details>
  <summary>Python code</summary>
  ```python
  df.isnull().sum()
  ```
</details>

### Data Cleaning

```{r}
glimpse(df)
```
<details>
  <summary>Python code</summary>
  ```python
  df.dtypes 
  ```
</details>

```{r}
names(df)
```
<details>
  <summary>Python code</summary>
  ```python
  df.columns
  ```
</details>

```{r}
df$Date_of_Journey <- as.POSIXct(df$Date_of_Journey, format="%d/%m/%Y")
df$Dep_Time <- as.POSIXct(df$Dep_Time, format="%H:%M")
df$Arrival_Time <- as.POSIXct(df$Arrival_Time, format="%H:%M")
```
<details>
  <summary>Python code</summary>
  ```python
  def change_into_datetime(col):
      df[col]=pd.to_datetime(df[col])
      
  for i in ['Date_of_Journey','Dep_Time', 'Arrival_Time']:
    change_into_datetime(i)
  ```
</details>

```{r}
glimpse(df)
```
<details>
  <summary>Python code</summary>
  ```python
  df.dtypes
  ```
</details>

```{r}
df$journey_day <- as.numeric(format(df$Date_of_Journey, "%d")) # extract day from Date_of_Journey `column`
df$journey_month <- as.numeric(format(df$Date_of_Journey, "%m")) # extract month from Date_of_Journey `column`
```
<details>
  <summary>Python code</summary>
  ```python
  df['journey_day']=df['Date_of_Journey'].dt.day
  df['journey_month']=df['Date_of_Journey'].dt.month
  ```
</details>

```{r}
head(df, 10)
```
<details>
  <summary>Python code</summary>
  ```python
  df.head(10)
  ```
</details>

```{r}
df <- df %>% select(-Date_of_Journey) # remove Date_of_Journey column
```
<details>
  <summary>Python code</summary>
  ```python
  df.drop('Date_of_Journey', axis=1, inplace=True)
  ```
</details>

```{r}
# extract hour and add a new column with the extracted hour values to the data frame
extract_hour <- function(data, col){
  # extract hour using the hour() function from the lubridate package and add a new column with the extracted values to the data frame
  data[[paste0(col, '_hour')]] <- hour(data[[col]])
  # return the modified data frame
  return(data)
}

# extract minute and add a new column with the extracted minute values to the data frame
extract_min <- function(data, col){
  # extract minute using the minute() function from the lubridate package and add a new column with the extracted values to the data frame
  data[[paste0(col, '_min')]] <- minute(data[[col]])
  # return the modified data frame
  return(data)
}

# funtion to drop a column from the data frame
drop_col <- function(data, col){
  data[[col]] <- NULL
  return(data)
}
```
<details>
  <summary>Python code</summary>
  ```python
  def extract_hour(data,col):
    data[col+'_hour']=data[col].dt.hour
    
  def extract_min(data,col):
      data[col+'_min']=data[col].dt.minute
      
  def drop_col(data,col):
      data.drop(col,axis=1,inplace=True)
  ```
</details>

```{r}
df <- extract_hour(df, 'Dep_Time')
df <- extract_min(df, 'Dep_Time')
df <- drop_col(df, 'Dep_Time')
```
<details>
  <summary>Python code</summary>
  ```python
  # Departure time is when a plane leaves the gate. 
  # Similar to Date_of_Journey we can extract values from Dep_Time
  extract_hour(df,'Dep_Time')
  
  #extracting minutes
  extract_min(df,'Dep_Time')
  
  #drop the column
  drop_col(df,'Dep_Time')
  ```
</details>

```{r}
df <- extract_hour(df, 'Arrival_Time')
df <- extract_min(df, 'Arrival_Time')
df <- drop_col(df, 'Arrival_Time')
```
<details>
  <summary>Python code</summary>
  ```python
  #extracting hour
  extract_hour(df,'Arrival_Time')
  
  #extracting min
  extract_min(df,'Arrival_Time')
  
  #drop the column
  drop_col(df,'Arrival_Time')
  ```
</details>

```{r}
head(df, 10)
```
<details>
  <summary>Python code</summary>
  ```python
  df.head(10)
  ```
</details>

```{r}
# create 'Duration' column, with values based on the existing 'Duration' column
df %>% 
  mutate(Duration = case_when(grepl("^[0-9]+h [0-9]+m$", Duration) ~ Duration, # if starts with one or more digits, followed by the letter "h", a space, one or more digits, and the letter "m", keep the original 'Duration' value
                              grepl("^[0-9]+h", Duration) ~ paste0(Duration, " 0m"), # if starts with one or more digits and the letter "h", append the string " 0m" to the end of the 'Duration' value
                              grepl("[0-9]+m$", Duration) ~ paste0("0h ", Duration), # if ends with one or more digits and the letter "m", prepend the string "0h " to the beginning of the 'Duration' value
                              # if none of the above, assign NA
                              TRUE ~ NA_character_)) -> df
```
<details>
  <summary>Python code</summary>
  ```python
  duration=list(df['Duration'])
  for i in range(len(duration)):
      if len(duration[i].split(' '))==2:
          pass
      else:
          if 'h' in duration[i]: # Check if duration contains only hour
               duration[i]=duration[i] + ' 0m' # Adds 0 minute
          else:
               duration[i]='0h '+ duration[i]
  ```
</details>

```{r}
head(df)
```
<details>
  <summary>Python code</summary>
  ```python
  df.head()
  ```
</details>

```{r}
hour <- function(x){
  ifelse(grepl("h", x), as.numeric(strsplit(x, 'h')[[1]][1]), 0)
}

minutes <- function(x){
  ifelse(is.na(x[2]), 0, as.numeric(sub(".*?(\\d+)m.*", "\\1", x[2])))
}
```
<details>
  <summary>Python code</summary>
  ```python
  def hour(x):
      return x.split(' ')[0][0:-1]
  
  def minutes(x):
      return x.split(' ')[1][0:-1]
  ```
</details>

```{r}
df$dur_hour <- sapply(df$Duration, hour)
```
<details>
  <summary>Python code</summary>
  ```python
  df['dur_hour']=df['Duration'].apply(hour)
  ```
</details>

```{r}
df$dur_min <- sapply(strsplit(df$Duration, ' '), minutes)
```
<details>
  <summary>Python code</summary>
  ```python
  df['dur_min']=df['Duration'].apply(minutes)
  ```
</details>

```{r}
head(df, 10)
```
<details>
  <summary>Python code</summary>
  ```python
  df.head(10)
  ```
</details>

```{r}
df <- df %>% 
  select(-Duration)
```
<details>
  <summary>Python code</summary>
  ```python
  drop_col(df,'Duration')
  ```
</details>

```{r}
str(df)
```
<details>
  <summary>Python code</summary>
  ```python
  df.dtypes
  ```
</details>

```{r}
df$dur_hour <- as.integer(df$dur_hour)
df$dur_min <- as.integer(df$dur_min)
```
<details>
  <summary>Python code</summary>
  ```python
  df['dur_hour'] = df['dur_hour'].astype(int)
  df['dur_min'] = df['dur_min'].astype(int)
  ```
</details>

```{r}
str(df)
```
<details>
  <summary>Python code</summary>
  ```python
  df.dtypes
  ```
</details>

#### Finding the categorical value

```{r}
column <- names(df)[sapply(df, is.character)]
column
```
<details>
  <summary>Python code</summary>
  ```python
  column=[column for column in df.columns if df[column].dtype=='object']
  column
  ```
</details>

#### Finding the continuous value

```{r}
continuous_col <- names(df)[!sapply(df, is.character)]
```
<details>
  <summary>Python code</summary>
  ```python
  continuous_col =[column for column in df.columns if df[column].dtype!='object']
  continuous_col
  ```
</details>

## Handling categorical data

```{r}
categorical <- df[column]
```
<details>
  <summary>Python code</summary>
  ```python
  categorical = df[column]
  ```
</details>

```{r}
head(categorical)
```
<details>
  <summary>Python code</summary>
  ```python
  categorical.head()
  ```
</details>

```{r}
table(categorical$Airline)
```
<details>
  <summary>Python code</summary>
  ```python
  categorical['Airline'].value_counts()
  ```
</details>

### Airline vs Price Analysis

```{r}
ggplot(data = df, aes(x = reorder(Airline, -Price), y = Price)) +
  geom_boxplot() +
  labs(x = "Airline", y = "Price")
```
<details>
  <summary>Python code</summary>
  ```python
  plt.figure(figsize=(15,8))
  sns.boxplot(x='Airline',y='Price',data=df.sort_values('Price',ascending=False))
  ```
</details>

```{r}
ggplot(data = df, aes(x = reorder(Total_Stops, -Price), y = Price)) +
  geom_boxplot() +
  labs(x = "Total_Stops", y = "Price")
```
<details>
  <summary>Python code</summary>
  ```python
  plt.figure(figsize=(15,8))
  sns.boxplot(x='Total_Stops',y='Price',data=df.sort_values('Price',ascending=False))
  ```
</details>

```{r}
Airline <- as.data.frame(model.matrix(~ Airline - 1, data = categorical))
new_names <- gsub("Airline", "", colnames(Airline))
Airline <- setNames(Airline, new_names)
```
<details>
  <summary>Python code</summary>
  ```python
  # As Airline is Nominal Categorical data we will perform OneHotEncoding
  Airline=pd.get_dummies(categorical['Airline'],drop_first=True)
  ```
</details>

```{r}
head(Airline)
```
<details>
  <summary>Python code</summary>
  ```python
  Airline.head()
  ```
</details>

```{r}
table(categorical$Source)
```
<details>
  <summary>Python code</summary>
  ```python
  categorical['Source'].value_counts()
  ```
</details>

```{r}
ggplot(data = df, aes(x = reorder(Source, -Price), y = Price)) +
  geom_boxplot() +
  labs(x = "Source", y = "Price")
```
<details>
  <summary>Python code</summary>
  ```python
  #Source vs Price
  plt.figure(figsize=(15,15))
  sns.catplot(x='Source',y='Price',data=df.sort_values('Price',ascending=False),kind='boxen')
  ```
</details>

```{r}
Source <- as.data.frame(model.matrix(~ Source - 1, data = categorical))
new_names <- gsub("Source", "", colnames(Source))
Source <- setNames(Source, new_names)

head(Source)
```
<details>
  <summary>Python code</summary>
  ```python
  #encoding of source column
  source=pd.get_dummies(categorical['Source'],drop_first=True)
  source.head()
  ```
</details>

```{r}
table(categorical$Destination)
```
<details>
  <summary>Python code</summary>
  ```python
  categorical['Destination'].value_counts()
  ```
</details>

```{r}
ggplot(data = df, aes(x = reorder(Destination, -Price), y = Price)) +
  geom_boxplot() +
  labs(x = "Destination", y = "Price")
```
<details>
  <summary>Python code</summary>
  ```python
  plt.figure(figsize=(15,8))
  sns.boxplot(x='Destination',y='Price',data=df.sort_values('Price',ascending=False))
  ```
</details>

```{r}
Destination <- as.data.frame(model.matrix(~ Destination - 1, data = categorical))
new_names <- gsub("Destination", "", colnames(Destination))
Destination <- setNames(Destination, new_names)

head(Destination)
```
<details>
  <summary>Python code</summary>
  ```python
  #encoding of destination column
  destination=pd.get_dummies(categorical['Destination'],drop_first=True)
  destination.head()
  ```
</details>

```{r}
table(categorical$Route)
```
<details>
  <summary>Python code</summary>
  ```python
  # now work on route column
  categorical['Route'].value_counts()
  ```
</details>

```{r}
categorical$Route1 <- sapply(strsplit(as.character(categorical$Route), "→"), "[", 1)
categorical$Route2 <- sapply(strsplit(as.character(categorical$Route), "→"), "[", 2)
categorical$Route3 <- sapply(strsplit(as.character(categorical$Route), "→"), "[", 3)
categorical$Route4 <- sapply(strsplit(as.character(categorical$Route), "→"), "[", 4)
categorical$Route5 <- sapply(strsplit(as.character(categorical$Route), "→"), "[", 5)
```
<details>
  <summary>Python code</summary>
  ```python
  categorical['Route1']=categorical['Route'].str.split('→').str[0]
  categorical['Route2']=categorical['Route'].str.split('→').str[1]
  categorical['Route3']=categorical['Route'].str.split('→').str[2]
  categorical['Route4']=categorical['Route'].str.split('→').str[3]
  categorical['Route5']=categorical['Route'].str.split('→').str[4]
  ```
</details>

```{r}
categorical %>%
  head(5) %>%
  datatable(options = list(dom = 't', 
                           paging = FALSE,
                           scrollX = TRUE,
                           scrollCollapse = TRUE))
```
<details>
  <summary>Python code</summary>
  ```python
  categorical.head()
  ```
</details>

```{r}
categorical <- categorical %>% 
  select(-Route)
```
<details>
  <summary>Python code</summary>
  ```python
  drop_col(categorical,'Route')
  ```
</details>

```{r}
categorical %>% 
  summarise_all(~ sum(is.na(.))) %>% 
  pivot_longer(cols = everything(),
               names_to = 'Variable',
               values_to = 'No. of missing values')
```
<details>
  <summary>Python code</summary>
  ```python
  categorical.isnull().sum()
  ```
</details>

```{r}
categorical %>% colnames()
```
<details>
  <summary>Python code</summary>
  ```python
  categorical.columns
  ```
</details>

```{r}
categorical <- categorical %>% 
  mutate(Route3 = if_else(is.na(Route3), 'None', Route3),
         Route4 = if_else(is.na(Route4), 'None', Route4),
         Route5 = if_else(is.na(Route5), 'None', Route5))
```
<details>
  <summary>Python code</summary>
  ```python
  for i in ['Route3', 'Route4', 'Route5']:
    categorical[i].fillna('None',inplace=True)
  ```
</details>


```{r}
categorical %>% 
  summarise_all(~ sum(is.na(.))) %>% 
  pivot_longer(cols = everything(),
               names_to = 'Variable',
               values_to = 'No. of missing values')
```
<details>
  <summary>Python code</summary>
  ```python
  categorical.isnull().sum()
  ```
</details>

```{r}
for (i in names(categorical)) {
  cat(paste0(i, " has total ", length(unique(categorical[[i]])), " categories\n"))
}
```
<details>
  <summary>Python code</summary>
  ```python
  for i in categorical.columns:
    print('{} has total {} categories'.format(i,len(categorical[i].value_counts())))
  ```
</details>

```{r}
df %>% 
ggplot(aes(x = Arrival_Time_hour, y = Price)) + 
  geom_hex(bins = 15, aes(fill = after_stat(count))) +
  scale_fill_gradient(low = 'white', high = 'darkgreen') +
  scale_y_continuous(breaks = seq(0, 80000, by = 10000)) +
  theme(panel.background = element_rect(fill = "white"))
```
<details>
  <summary>Python code</summary>
  ```python
  df.plot.hexbin(x='Arrival_Time_hour',y='Price',gridsize=15)
  ```
</details>

```{r}
for (i in c("Route1", "Route2", "Route3", "Route4", "Route5")){
  categorical[[i]] <- factor(categorical[[i]]) %>% as.numeric()
}
```
<details>
  <summary>Python code</summary>
  ```python
  # Applying label encoder
  from sklearn.preprocessing import LabelEncoder
  encoder = LabelEncoder()
  for i in ['Route1', 'Route2', 'Route3', 'Route4', 'Route5']:
    categorical[i]=encoder.fit_transform(categorical[i])
  ```
</details>

```{r}
categorical %>% 
  head(5)
```
<details>
  <summary>Python code</summary>
  ```python
  categorical.head()
  ```
</details>

```{r}
categorical <- categorical %>% 
  select(-Additional_Info)
```
<details>
  <summary>Python code</summary>
  ```python
  drop_col(categorical,'Additional_Info')
  ```
</details>


```{r}
categorical %>% 
  select(Total_Stops) %>% 
  unique()
```
<details>
  <summary>Python code</summary>
  ```python
  categorical['Total_Stops'].unique()
  ```
</details>

```{r}
map_levels <- c('non-stop', '1 stop', '2 stops',  '3 stops', '4 stops')
map_values <- c(0, 1, 2, 3, 4)
categorical[['Total_Stops']] <- factor(categorical$Total_Stops, levels = map_levels, labels = map_values) %>% as.numeric() - 1
```
<details>
  <summary>Python code</summary>
  ```python
  # encoding Total stops
  dict={'non-stop':0, '2 stops':2, '1 stop':1, '3 stops':3, '4 stops':4}
  categorical['Total_Stops']=categorical['Total_Stops'].map(dict)
  ```
</details>

```{r}
categorical %>% 
  select(Total_Stops)
```
<details>
  <summary>Python code</summary>
  ```python
  categorical['Total_Stops']
  ```
</details>

```{r}
categorical <- categorical %>% 
  select(-Source, -Destination, -Airline)
```
<details>
  <summary>Python code</summary>
  ```python
  drop_col(categorical,'Source')
  drop_col(categorical,'Destination')
  drop_col(categorical,'Airline')
  ```
</details>


```{r}
final_df <- cbind(categorical, Airline, Source, Destination, df[continuous_col])
final_df <- final_df[!duplicated(names(final_df))]
```
<details>
  <summary>Python code</summary>
  ```python
  final_df=pd.concat([categorical,Airline,source,destination,df[continuous_col]],axis=1)
  ```
</details>

```{r}
final_df %>% 
  head(5) %>%
    datatable(options = list(dom = 't', 
                           paging = FALSE,
                           scrollX = TRUE,
                           scrollCollapse = TRUE))
```
<details>
  <summary>Python code</summary>
  ```python
  final_df.head()
  ```
</details>

```{r}
options(max.print = 33)
final_df %>% 
  head(5) %>% 
    datatable(options = list(dom = 't', 
                           paging = FALSE,
                           scrollX = TRUE,
                           scrollCollapse = TRUE))
```
<details>
  <summary>Python code</summary>
  ```python
  pd.set_option('display.max_columns',33)
  final_df.head()
  ```
</details>

## Check For Outliers

```{r}
plot <- function(data, col) {
  
  p1 <- ggplot(data, aes(x = .data[[col]])) +
    geom_histogram(aes(y = ..density..), fill = "lightblue", alpha = 0.5) +
    geom_density(color = "darkblue", linewidth = 1) +
    labs(x = col, y = "Frequency") +
    theme_bw()
  
  p2 <- ggplot(data, aes(y = .data[[col]])) +
    geom_boxplot(fill = "darkblue", color = "black", alpha = 0.5) +
    labs(x = "", y = col) +
    theme_bw() +
    coord_flip()
  
  ggarrange(p1, p2, ncol = 1, nrow = 2)
}
```
<details>
  <summary>Python code</summary>
  ```python
  def plot(data,col):
    fig,(ax1,ax2)=plt.subplots(2,1)
    sns.distplot(data[col],ax=ax1)
    sns.boxplot(data[col],ax=ax2)
  ```
</details>

```{r message=FALSE, warning=FALSE}
plot(final_df,'Price')
```
<details>
  <summary>Python code</summary>
  ```python
  plot(final_df,'Price')
  ```
</details>
## Feature Selection

## Models

## Hypertunning the model